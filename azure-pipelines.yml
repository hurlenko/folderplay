name: $(Build.SourceBranch)-$(date:yyyyMMdd)$(rev:.r)

# Trigger for pull requests only
trigger: none

jobs:
  - job: build_artifacts
    displayName: 'Build Artifacts'
    strategy:
      matrix:
        linux:
          imageName: 'ubuntu-latest'
          python.version: '3.7'
        mac:
          imageName: 'macos-latest'
          python.version: '3.7'
        windows:
          imageName: 'windows-latest'
          python.version: '3.7'

    pool:
      vmImage: '$(imageName)'

    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '$(python.version)'
          architecture: 'x64'
        displayName: 'Use Python $(python.version)'

      - script: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        displayName: 'Install dependencies'

      - script: |
          python -m PyInstaller folderplay.spec
        displayName: 'Build pyinstaller'

      - task: PublishBuildArtifacts@1
        inputs:
          artifactName: 'drop'
          pathtoPublish: '$(Build.SourcesDirectory)/dist'

  - job: 'github_release'
    displayName: 'Create GitHub release'
    dependsOn: build_artifacts
    condition: succeeded()

    steps:
      - task: DownloadBuildArtifacts@0
        displayName: 'Download Build Artifacts'
        inputs:
          artifactName: 'drop'
          downloadPath: '$(Build.ArtifactStagingDirectory)'

      - task: GithubRelease@0
        displayName: 'Create release'
        inputs:
          gitHubConnection: 'folderplay'
          repositoryName: '$(Build.Repository.Name)'
          action: 'create'
          target: '$(Build.SourceVersion)'
          tagSource: 'auto'
          assets: '$(Build.ArtifactStagingDirectory)/drop/*'
          assetUploadMode: 'replace'
          addChangeLog: true
          isDraft: true